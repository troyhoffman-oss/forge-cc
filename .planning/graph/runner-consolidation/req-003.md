---
id: req-003
title: "PostToolUse Bash hook — PR and merge reactions"
group: Hook Infrastructure
dependsOn: []
files:
  creates:
    - hooks/linear-post-action.js
  modifies: []
acceptance:
  - "When gh pr create succeeds, the hook links the PR to all complete requirement issues via attachIssuePullRequest() and transitions the project to In Review"
  - "When gh pr merge succeeds, the hook transitions the project to Completed via syncGraphProjectCompleted()"
  - "The hook runs async (does not block the agent) for PR creation reactions"
  - "The hook bails out in under 10ms for non-matching Bash commands"
  - "If Linear API calls fail, the hook logs warnings but does not error"
---

## Context
Agents create PRs with `gh pr create` and merge with `gh pr merge`. These are natural actions the agent already takes. This PostToolUse hook reacts to those actions and syncs Linear state — replacing the `forge linear ship` CLI command that agents skip.

## Technical Approach
1. Create `hooks/linear-post-action.js` as a PostToolUse command hook with matcher `Bash`
2. Read stdin JSON, extract `tool_input.command` and `tool_response`
3. Fast bail-out: if command doesn't contain `gh pr create` or `gh pr merge`, exit 0
4. For `gh pr create`:
   - Parse PR URL from `tool_response` (gh pr create outputs the URL)
   - Discover active graph: scan `.planning/graph/*/` for graphs matching current branch
   - Load the graph index
   - For each complete requirement with a `linearIssueId`: call `attachIssuePullRequest(issueId, prUrl)`
   - Call `syncGraphProjectReview(client, index)` to transition project to In Review
   - Return `{ hookSpecificOutput: { additionalContext: "Linear: PR linked to N issues, project → In Review" } }`
5. For `gh pr merge`:
   - Discover active graph from branch name
   - Call `syncGraphProjectCompleted(client, index)` to transition project to Completed
   - Return additionalContext confirming the transition
6. All Linear API calls are best-effort — catch errors, log warnings, never fail the hook

## Interview Notes
- This hook replaces the need for agents to call `forge linear ship`
- The `attachIssuePullRequest` logic already exists in cli.ts ship command (lines 407-423) — reuse that pattern
- Should run async for PR creation (Linear API calls can be slow)
- Graph discovery: match current git branch against `index.branch` in each `_index.yaml`
