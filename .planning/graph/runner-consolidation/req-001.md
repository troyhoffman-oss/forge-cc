---
id: req-001
title: "WorktreeCreate hook — branch naming + issue sync"
group: Hook Infrastructure
dependsOn: []
files:
  creates:
    - hooks/linear-worktree-create.js
  modifies:
    - src/linear/sync.ts
acceptance:
  - "When Task tool uses isolation:worktree, the WorktreeCreate hook fires and creates a worktree with a branch name containing the Linear issue identifier (e.g., feat/slug/FRG-132-req-001)"
  - "The hook calls syncRequirementStart() to transition the issue to In Progress and the project to In Progress (first time)"
  - "If the hook cannot resolve the requirement or Linear identifier, it falls back to creating a generic worktree (degraded but not broken)"
  - "Hook reads _index.yaml to map worktree name → requirement → linearIssueId → issue identifier"
---

## Context
When agents use the Task tool with `isolation: "worktree"`, Claude Code creates a worktree with an auto-generated branch name (e.g., `worktree-agent-a166d1a2`). This branch name contains no Linear identifier, so Linear's native GitHub integration can't auto-link the issue. The WorktreeCreate hook replaces the default worktree creation behavior, allowing us to inject the correct branch name.

## Technical Approach
1. Create `hooks/linear-worktree-create.js` as a command hook script
2. The hook reads stdin JSON — receives `{ name: "some-slug", cwd: "...", ... }`
3. The hook resolves context:
   - Parse the `name` field to extract a reqId (if the Task tool passes agent name as worktree name)
   - Fall back to reading `.forge/build-context.json` if name doesn't contain reqId
   - Look up `_index.yaml` in `.planning/graph/*/` to find the requirement's `linearIssueId`
   - Call `getIssueIdentifier(linearIssueId)` to get `FRG-132`
4. Create the worktree: `git worktree add <path> -b <branch-name>` where branch-name includes the Linear identifier
5. Call `syncRequirementStart()` to transition issue + project to In Progress
6. Print the absolute worktree path to stdout (required by WorktreeCreate contract)
7. If any step fails, fall back to default worktree creation without Linear identifier

Add a helper to `src/linear/sync.ts`: `resolveRequirementContext(projectDir, reqId)` that returns `{ index, meta, issueIdentifier }` — shared by this hook and the PreToolUse hook.

## Interview Notes
- The Task tool's `name` parameter may or may not flow through as the WorktreeCreate `name` field — needs verification during implementation
- If it doesn't, use a `.forge/build-context.json` state file as fallback
- Graceful degradation is critical — a broken hook should not prevent worktree creation
