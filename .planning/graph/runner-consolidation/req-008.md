---
id: req-008
title: "forge setup installs hooks into settings.json"
group: Hook Installation
dependsOn:
  - req-001
  - req-002
  - req-003
files:
  creates: []
  modifies:
    - src/setup.ts
acceptance:
  - "forge setup installs WorktreeCreate, PreToolUse, and PostToolUse hook configurations into .claude/settings.json"
  - "Hook installation is idempotent — running setup twice doesn't create duplicate entries"
  - "Existing hooks (pre-commit-verify) are preserved, not overwritten"
  - "Hook commands reference the forge-cc package path correctly on both Windows and Unix"
---

## Context
Hooks defined in `.claude/settings.json` are global — they fire in every session. This is the fallback if skill frontmatter hooks (req-007) don't work for command-directory skills. Even if frontmatter works, global installation via setup provides a safety net that hooks are always available.

## Technical Approach
1. Update `src/setup.ts` `runSetup()` to add a hook installation step:
   - Read existing `.claude/settings.json` (or create it)
   - Merge forge hook configurations into the `hooks` section
   - Preserve existing hooks (especially pre-commit-verify)
   - Write the updated settings

2. Hook configuration to install:
   ```json
   {
     "hooks": {
       "WorktreeCreate": [{
         "hooks": [{
           "type": "command",
           "command": "node \"$CLAUDE_PROJECT_DIR/node_modules/forge-cc/hooks/linear-worktree-create.js\""
         }]
       }],
       "PreToolUse": [{
         "matcher": "Bash",
         "hooks": [{
           "type": "command",
           "command": "node \"$CLAUDE_PROJECT_DIR/node_modules/forge-cc/hooks/linear-branch-enforce.js\""
         }]
       }],
       "PostToolUse": [{
         "matcher": "Bash",
         "hooks": [{
           "type": "command",
           "command": "node \"$CLAUDE_PROJECT_DIR/node_modules/forge-cc/hooks/linear-post-action.js\"",
           "async": true
         }]
       }]
     }
   }
   ```

3. Idempotency: check if forge hooks already exist before adding. Use a comment or marker to identify forge-managed hooks.

4. Windows path handling: use `$CLAUDE_PROJECT_DIR` env var (works cross-platform). Reference the learned rule about Windows paths with forge-cc.

## Interview Notes
- Hook installation timing: settings.json is snapshotted at session start. Hooks take effect on next session.
- The postinstall script already calls `forge setup --skills-only` — could extend to include hook installation
- Must not break existing pre-commit-verify hook registration
