---
id: req-001
title: "Refactor codex-poll to return data instead of process.exit"
group: Infrastructure
dependsOn: []
files:
  creates: []
  modifies:
    - src/codex-poll.ts
    - tests/codex-poll.test.ts
acceptance:
  - "pollForCodexReview returns a result object { found: boolean, reviews: [], comments: [] } instead of calling process.exit"
  - "Existing isCodexActivity and fetchAllPages functions remain unchanged"
  - "CLI command in cli.ts still works (handles process.exit at the CLI layer)"
  - "All existing tests pass; new tests cover the return-value path"
---

## Context
The current `pollForCodexReview` function calls `process.exit(0)` on success and `process.exit(1)` on failure/timeout. This makes it unusable as a library function — skills need to call it programmatically and act on the result. The function needs to return structured data instead, with `process.exit` handled only at the CLI layer in `cli.ts`.

## Technical Approach
1. Change `pollForCodexReview` return type to `Promise<CodexPollResult>` where:
   ```ts
   export interface CodexPollResult {
     found: boolean;
     reviews: Array<{ id: number; state: string; body: string; user?: string }>;
     comments: Array<{ id: number; body: string; path?: string; user?: string }>;
     error?: string;
   }
   ```
2. Remove `process.exit()` calls from `pollForCodexReview` — return the result object instead
3. Move `process.exit` logic to the CLI action in `cli.ts` (already the pattern used by other commands)
4. Update `console.log(JSON.stringify(...))` to just return the data
5. Keep `console.error` for progress messages (polling attempt N/8)
6. Update tests: the timeout test currently expects `process.exit(1)` — change to expect the returned `{ found: false }` result
