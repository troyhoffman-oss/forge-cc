---
id: req-005
title: "Fix resolveIssueStateByCategory name-based fallback"
group: "bugfix"
dependsOn: []
files:
  creates: []
  modifies:
    - src/linear/client.ts
    - tests/linear/linear.test.ts
acceptance:
  - "resolveIssueStateByCategory first tries category-based lookup (existing behavior)"
  - "When category lookup returns no results, falls back to name-based lookup across all workflow states for the team"
  - "Name-based fallback uses nameHint parameter if provided, otherwise uses a category-to-name mapping (started→In Progress, completed→Done, planned→Planned, etc.)"
  - "If both category and name lookups fail, throws with a descriptive error"
  - "Test covers: category hit, category miss with name fallback hit, both miss throws"
---

## Context
Troy's Linear team has a "Planned" issue state with `undefined` category. The current `resolveIssueStateByCategory` filters by `type: { eq: category }` which returns empty results when the state has no category set. The fix adds a name-based fallback that queries all states for the team and matches by name.

## Technical Approach
In `src/linear/client.ts`, modify `resolveIssueStateByCategory()` (line 36):

```typescript
async resolveIssueStateByCategory(teamId: string, category: string, nameHint?: string): Promise<string> {
  // 1. Try category-based lookup (existing behavior)
  const states = await this.client.workflowStates({
    filter: { team: { id: { eq: teamId } }, type: { eq: category } },
  });
  if (states.nodes.length > 0) {
    if (nameHint) {
      const match = states.nodes.find((s) => s.name === nameHint);
      if (match) return match.id;
    }
    return states.nodes[0].id;
  }

  // 2. Fallback: search all states by name
  const nameToFind = nameHint ?? categoryToName(category);
  const allStates = await this.client.workflowStates({
    filter: { team: { id: { eq: teamId } } },
  });
  const nameMatch = allStates.nodes.find((s) => s.name === nameToFind);
  if (nameMatch) return nameMatch.id;

  throw new Error(`No workflow state matching category "${category}" or name "${nameToFind}" for team ${teamId}`);
}
```

Add a helper mapping:
```typescript
function categoryToName(category: string): string {
  const map: Record<string, string> = {
    started: "In Progress",
    completed: "Done",
    planned: "Planned",
    backlog: "Backlog",
    cancelled: "Cancelled",
    triage: "Triage",
  };
  return map[category] ?? category;
}
```

In `tests/linear/linear.test.ts`, add tests for:
- Category lookup succeeds (existing behavior)
- Category lookup fails, name fallback succeeds
- Both fail, throws error

## Interview Notes
User confirmed: fix should apply to all states (not just Planned). The nameHint parameter already exists on the function signature — it's used by callers like `syncMilestoneStart(... "started", "In Progress")`.
